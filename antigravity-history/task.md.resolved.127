# MIYAR V4 — The Fit-out Oracle: Task List

## Phase A: Schema + Types + Area Utility
- [x] Add `totalFitoutArea`, `totalNonFinishArea`, `fitoutAreaVerified`, `projectArchetype` to [schema.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts)
- [x] Add `pdf_extractions` table to [schema.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts)
- [x] Extend `status` enum with `draft_area_verification`
- [x] Add `totalFitoutArea` to [ProjectInputs](file:///Users/amrosaleh/Maiyar/miyar-v2/shared/miyar-types.ts#17-57) in [miyar-types.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/shared/miyar-types.ts)
- [x] Add [ProjectArchetype](file:///Users/amrosaleh/Maiyar/miyar-v2/shared/miyar-types.ts#9-10) type to [miyar-types.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/shared/miyar-types.ts)
- [x] Create [server/engines/area-utils.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts) — [getPricingArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#9-17), [getStructuralArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#18-25)
- [x] Add typed Zod schemas for `unitMix` and `villaSpaces` in [project.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/project.ts)
- [x] Update `projectInputSchema` with new fields in [project.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/project.ts)
- [x] Update [projectToInputs()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design-advisor.ts#12-46) to include `totalFitoutArea`
- [x] Run `npm run db:push` to apply schema changes

## Phase B: Adaptive Project Creator UI
- [ ] Map typology → archetype in `ProjectNew.tsx`
- [ ] Add Unit Mix Builder sub-form (residential archetype)
- [ ] Add Room List Builder sub-form (villa archetype)
- [ ] Add Shell & Core toggle (office archetype)
- [ ] Auto-calculate `totalFitoutArea` from sub-forms
- [ ] Show fitout area summary in Review step

## Phase C: Engine Migration (50+ callsites)
- [x] Update [normalization.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/normalization.ts) — [deriveScaleBand()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/normalization.ts#26-34) uses [getPricingArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#9-17)
- [x] Update [scoring.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/scoring.ts) — [computeROI()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/scoring.ts#369-430) uses [getPricingArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#9-17)
- [x] Update [design-brief.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design-brief.ts) — pricing uses fitout area
- [x] Update [bias-detector.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/bias/bias-detector.ts) — budget calc uses [getPricingArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#9-17)
- [x] Update `ai-design-advisor.ts` — AI prompts show both GFA + fitout area
- [x] Update [explainability.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/explainability.ts) — add `totalFitoutArea` label
- [ ] Update `pdf-report.ts` — show both GFA and Fitout Area
- [x] Update routers: [design.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts), [design-advisor.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design-advisor.ts), `portfolio.ts`, [scenario.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/scenario.ts), `predictive.ts`, [seed.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/seed.ts)
- [x] Update 9 test files with `totalFitoutArea` in fixtures
- [x] Run `npm test` — all V4 tests pass (732 passed, 5 pre-existing failures)
- [ ] Run `npx tsc --noEmit` — no type errors

## Phase D: Verification Gate + PDF Extraction
- [ ] Add `project.verifyAreas` tRPC mutation
- [ ] Create `AreaVerification.tsx` page
- [ ] Add Gemini vision PDF extraction engine
- [ ] Create `PdfPreview.tsx` polygon viewer
- [ ] Integration testing end-to-end

## Verification
- [ ] Create project with each archetype — verify conditional fields
- [ ] Evaluate project — verify ROI uses fitout area
- [ ] Generate design brief — verify pricing uses fitout area
- [ ] Git commit + push
