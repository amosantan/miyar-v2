# Ship-Blockers Walkthrough — P0 → P3 + Activation

## P0 — Ship-blockers ✅ `aa58a91`
- DB migrations for 8 Phase D–H tables → PlanetScale
- Auth guards on all 57 routes ([RequireAuth](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/components/RouteGuards.tsx#4-23) + [RequireAdmin](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/components/RouteGuards.tsx#24-49))

## P1 — High Priority ✅ `39fac3e`
- 55 engine tests (Monte Carlo + Digital Twin)
- Rate limiting via `heavyProcedure` (5 req/min)
- CI/CD GitHub Actions · Sentry error tracking
- 27 `any` → proper type fixes

## P2 — Medium Priority ✅ `8434bf1`

| Item | File |
|------|------|
| Onboarding flow | [OnboardingFlow.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/components/OnboardingFlow.tsx) |
| Command palette ⌘K | [CommandPalette.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/components/CommandPalette.tsx) |
| Data export (CSV/JSON/PDF) | [export.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/lib/export.ts) + [ExportBar.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/components/ExportBar.tsx) |
| Historical tracking | [0034_historical_tracking.sql](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/0034_historical_tracking.sql) |
| 40+ DB indexes | [0033_add_indexes.sql](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/0033_add_indexes.sql) |
| Mobile responsive CSS | [index.css](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/index.css) |

## P3 — Nice to Have ✅ `0e4fb2d`

| Item | File |
|------|------|
| E2E test suite | [playwright.config.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/playwright.config.ts) + [core.spec.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/e2e/core.spec.ts) |
| Material data → DB | [0035_material_constants.sql](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/0035_material_constants.sql) |
| SSE notifications | [sse-notifications.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/_core/sse-notifications.ts) |
| 2FA (TOTP) | [two-factor.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/_core/two-factor.ts) |
| API docs | [api-docs.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/_core/api-docs.ts) → `/api/docs` + `/api/docs/html` |
| i18n (EN + AR) | [i18n.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/lib/i18n.tsx) (80+ keys, RTL) |
| Structured logging | [logger.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/_core/logger.ts) |

## Activation ✅ `9fb2a36`

### 1. PlanetScale Migrations Applied ✅
- **Tables created**: `sustainability_snapshots`, `material_constants`
- **Seeded**: 9 material types (concrete, steel, glass, aluminum, timber, stone, gypsum, insulation, ceramic)
- **Indexes**: ~9 new indexes across existing + new tables
- Reusable migration runner: [apply-migrations.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/scripts/apply-migrations.ts)

> [!NOTE]
> Some index migrations were skipped because certain early Phase D tables don't exist in PlanetScale yet (e.g., `market_evidence_records`, `notifications`, `ingestion_batches`). These will naturally apply when those tables are created.

### 2. npm Dependencies Installed ✅
Installed via **pnpm** (project package manager):
- `@playwright/test` — E2E testing
- `otplib` — TOTP 2FA secret generation/verification
- `qrcode` + `@types/qrcode` — QR code generation for 2FA setup

### 3. I18nProvider Wired ✅
`<I18nProvider>` wrapped around app root in [main.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/main.tsx). All components can now use [useTranslation()](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/lib/i18n.tsx#192-195).

### 4. Production Env Vars

| Variable | Recommended Value |
|----------|------------------|
| `LOG_LEVEL` | [info](file:///Users/amrosaleh/Maiyar/miyar-v2/server/_core/logger.ts#64-65) |
| `LOG_FORMAT` | [json](file:///Users/amrosaleh/Maiyar/miyar-v2/vercel.json) (production) / `pretty` (dev) |
| `SENTRY_DSN` | Already configured |

## Verification
- **733 / 759** tests pass (4 pre-existing `board-pdf` failures)
- PlanetScale data verified: 9 materials + `sustainability_snapshots` table confirmed
