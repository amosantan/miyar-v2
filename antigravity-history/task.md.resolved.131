# MIYAR V4 — The Fit-out Oracle: Task List

## Phase A: Schema + Types + Area Utility
- [x] Add `totalFitoutArea`, `totalNonFinishArea`, `fitoutAreaVerified`, `projectArchetype` to [schema.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts)
- [x] Add `pdf_extractions` table to [schema.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts)
- [x] Extend [status](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pdf-report.ts#19-24) enum with `draft_area_verification`
- [x] Add `totalFitoutArea` to `ProjectInputs` in `miyar-types.ts`
- [x] Add [ProjectArchetype](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/ProjectNew.tsx#92-93) type to `miyar-types.ts`
- [x] Create [server/engines/area-utils.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts) — [getPricingArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#9-17), [getStructuralArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#18-25)
- [x] Add typed Zod schemas for `unitMix` and `villaSpaces` in [project.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/project.ts)
- [x] Update `projectInputSchema` with new fields in [project.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/project.ts)
- [x] Update [projectToInputs()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts#21-55) to include `totalFitoutArea`
- [x] Run `npm run db:push` to apply schema changes

## Phase B: Adaptive Project Creator UI
- [x] Map typology → archetype in [ProjectNew.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/ProjectNew.tsx)
- [x] Add Unit Mix Builder sub-form (residential archetype)
- [x] Add Room List Builder sub-form (villa archetype)
- [x] Add Shell & Core toggle (office archetype)
- [x] Auto-calculate `totalFitoutArea` from sub-forms
- [x] Show fitout area summary in Review step

## Phase C: Engine Migration (50+ callsites)
- [x] Update `normalization.ts` — `deriveScaleBand()` uses [getPricingArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#9-17)
- [x] Update `scoring.ts` — `computeROI()` uses [getPricingArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#9-17)
- [x] Update `design-brief.ts` — pricing uses fitout area
- [x] Update `bias-detector.ts` — budget calc uses [getPricingArea()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/area-utils.ts#9-17)
- [x] Update [ai-design-advisor.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design/ai-design-advisor.ts) — AI prompts show both GFA + fitout area
- [x] Update `explainability.ts` — add `totalFitoutArea` label
- [x] Update [pdf-report.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pdf-report.ts) — show both GFA and Fitout Area
- [x] Update routers: [design.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts), [design-advisor.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design/ai-design-advisor.ts), `portfolio.ts`, `scenario.ts`, `predictive.ts`, `seed.ts`
- [x] Update 9 test files with `totalFitoutArea` in fixtures
- [x] Run `npm test` — all V4 tests pass (732 passed, 5 pre-existing failures)
- [x] Run `npx tsc --noEmit` — 72 errors all pre-existing, zero from V4 changes

## Phase D: Verification Gate + PDF Extraction
- [/] Add `project.verifyAreas` tRPC mutation
- [/] Create `AreaVerification.tsx` page
- [/] Add Gemini vision PDF extraction engine
- [/] Create `PdfPreview.tsx` room viewer
- [ ] Integration testing end-to-end

## Verification
- [ ] Create project with each archetype — verify conditional fields
- [ ] Evaluate project — verify ROI uses fitout area
- [ ] Generate design brief — verify pricing uses fitout area
- [ ] Git commit + push
