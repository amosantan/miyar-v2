# Design Intelligence Engine — Phase 1 & 2 Walkthrough

## Phase 1 Audit — What We Found

| Component | Status |
|-----------|--------|
| `designRouter` in [server/routers.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers.ts) | ✅ Registered correctly |
| `designAdvisorRouter` in [server/routers.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers.ts) | ✅ Registered correctly |
| [DesignBrief](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts#533-534), `DesignAdvisor`, `DesignStudio` pages | ✅ Routed in [App.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/App.tsx) |
| `pricing-engine.ts` | ✅ Real (reads live benchmark proposals from DB) |
| `nano-banana-client.ts` | ✅ Real (calls Gemini image API) |
| [design-brief.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design-brief.ts) engine | ✅ Real (generates 7-section structured briefs) |
| `material_constants` table | ❌ **SEEDED IN DB BUT NEVER QUERIED** — gap fixed below |

## Phase 1 Fix — `material_constants` Bridge

**Problem:** The `material_constants` table (9 materials, real AED/m² prices, carbon intensity, maintenance factors) existed in PlanetScale but was never imported or queried by any server code.

**Fixes applied:**

### [server/db.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts)
- Added `materialConstants` to the Drizzle import block
- Added [getMaterialConstants()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2098-2104) — returns all seeded material constants ordered by type
- Added [getMaterialConstantByType(materialType)](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2105-2114) — lookup by material name

### [server/routers/design.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts)
- Added `design.getMaterialConstants` — query endpoint for frontend consumption
- Added `design.calculateSpec` — full cost/carbon/maintenance/sustainability calculator:
  - Input: `[{ materialType, areaM2 }]` array
  - Output: `totalCostAed`, `totalCarbonKg`, `avgMaintenanceFactor`, `sustainabilityGrade (A–E)`, `costPerM2Avg`, per-line `breakdown[]`
  - Matches materialType strings against the `material_constants` table; unknown types are skipped gracefully

## Phase 2 — Investor Dashboard

### New file: [client/src/pages/InvestorSummary.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/InvestorSummary.tsx)

The missing "investor-facing view" — a unified 4-section page that synthesizes data from design brief, space recommendations, and material constants:

| Section | What it shows |
|---------|---------------|
| **A · Design Identity** | Typology, style, market tier, location + executive summary + design direction JSON |
| **B · Material Specification** | Full material list from space recommendations + UAE market AED/m² reference table from `material_constants` |
| **C · Budget Synthesis** | Total fitout budget, $/sqm, spaces covered + bar chart of budget allocation by space |
| **D · ROI Bridge** | Sustainability grade, maintenance indicator, sales premium estimate (tier-based), net uplift calculation |

### Route: [App.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/App.tsx)
Added: `/projects/:id/investor-summary` → [InvestorSummary](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/InvestorSummary.tsx#537-544) (protected)

### Navigation: [ProjectDetail.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/ProjectDetail.tsx)
Added **"Investor View"** button (violet) in the project header, next to the AI Design Advisor button.

## TypeScript Status

All lint errors resolved:
- Removed non-existent `design.getRfqLines` call
- Added explicit types to all implicit `any` callback parameters
- Fixed `Record<string, number>` index lookup for tier premium
- Added `Building2` to lucide-react imports in [ProjectDetail.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/ProjectDetail.tsx)

## Next Steps (Phase 5)

- DOCX export: add material cost table + AI-generated images to [docx-brief.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/docx-brief.ts)
- PDF Investor Report: puppeteer/pdfkit render of InvestorSummary
- Shareable token-gated `/share/:token` public link (no login required)

---

## Phase 4 — Market Grounding

### 4.1 Trend Signals → Gemini Prompt

**[server/db.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts)**
- [getDesignTrends({ styleClassification?, region?, limit? })](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2117-2136) — filters by style, sorts by mentionCount
- Added `asc` to drizzle-orm import, `designTrends` to schema import block

**[server/routers/design-advisor.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design-advisor.ts)**
- `generateRecommendations` now fetches UAE design trends (style-filtered, UAE region, top 20)
- Falls back to all UAE trends if no style-specific results
- Passes trends as 5th arg to [generateDesignRecommendations()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design/ai-design-advisor.ts#36-68)

**[server/engines/design/ai-design-advisor.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design/ai-design-advisor.ts)**
- [generateDesignRecommendations()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design/ai-design-advisor.ts#36-68) accepts optional `designTrends[]` 5th param
- New [buildTrendContext()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design/ai-design-advisor.ts#188-224) helper — groups trends by category, sorts established > emerging > declining, top 12
- Injects `## UAE Design Trends` block into Gemini prompt (between market intel and instructions) when trends exist

### 4.2 Benchmark Overlay (BriefEditor sidebar)

**[server/db.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts)**
- [getBenchmarkForProject(typology, location, marketTier)](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2137-2166) — 3-level progressive fallback (exact → typology+tier → tier only), converts sqft→sqm (×10.7639)

**[server/routers/design.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts)**
- `design.getBenchmarkForProject` query — reads project ctx, calls getBenchmarkForProject, returns AED/sqm low/mid/high

**[client/src/pages/BriefEditor.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/BriefEditor.tsx)**
- Fetches [getBenchmarkForProject](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2137-2166) and displays **Market Benchmark** card in sidebar
- Shows Low / Mid / High AED/sqm range from `benchmarkData`
- Live comparison: "Your estimate" displayed green (✓) if ≤ mid benchmark, amber (↑) if above

### 4.3 Market Intelligence Section (InvestorSummary)

**[server/db.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts)**
- [getActiveSourceRegistry(limit)](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2167-2191) — whitelisted + active sources, sorted by reliability A→B→C then lastSuccessfulFetch

**[server/routers/design.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts)**
- `design.getDesignTrends` query — project-scoped, style-filtered, top 20
- `design.getCompetitorContext` query — top 6 active sources from source_registry

**[client/src/pages/InvestorSummary.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/InvestorSummary.tsx)**
- Added **Section E — Market Intelligence** (only renders when data exists)
- Left panel: UAE Design Trends grid — trend badges (established/emerging/declining color-coded), category badge, description
- Right panel: Market Data Sources — reliability grade (A/B/C color-coded), source type, record count, external link icon

### Commit
`6278c62` — 6 files, 364 insertions

---

## Phase 5 — Export & Handover

### 5.1 [server/engines/investor-pdf.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/investor-pdf.ts) (new)

HTML template PDF engine following the same pattern as [board-pdf.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/board-pdf.ts) (browser print-to-PDF).

| Section | Contents |
|---------|----------|
| **Cover** | Project name, typology/tier/location/GFA, 3 KPI cards (fitout budget, AED/m², sustainability grade), watermark |
| **A · Design Identity** | Typology/style/tier/location KPIs, exec summary, design direction key-values |
| **B · Material Specification** | Material list table (product/brand/space/price), UAE material constants table (AED/m², carbon, grade) |
| **C · Budget Synthesis** | KPI strip (total/sqm/GFA), bar chart by space, Market Benchmark panel (Low/Mid/High + your estimate) |
| **D · ROI Bridge** | Sustainability grade chip, design premium %, ROI summary grid (invest → premium → net uplift) |
| **E · Market Intelligence** | UAE Design Trends with confidence badges |

Print button at top-right triggers browser print dialog for PDF save.

### 5.2 [server/db.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts) — 3 new helpers

- [getAiDesignBrief(projectId)](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2065-2075) — latest brief by projectId (no orgId check, internal use)
- [updateAiDesignBriefShareToken(briefId, token, expiresAt)](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2076-2084) — stores token + expiry
- [getAiDesignBriefByShareToken(token)](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#2085-2094) — resolves token for public share endpoint

### 5.3 [drizzle/schema.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts)

Added two nullable columns to `ai_design_briefs`:
- `shareToken varchar(64)` — 32-char nanoid
- `shareExpiresAt timestamp` — defaults to 7 days from creation

> ⚠️ **Run `npm run db:push` in your terminal to apply these columns to PlanetScale.**

### 5.4 [server/routers/design.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts) — 3 Phase 5 endpoints

| Endpoint | Type | Auth |
|----------|------|------|
| `design.exportInvestorPdf` | mutation | orgProcedure |
| `design.createShareLink` | mutation | orgProcedure |
| `design.resolveShareLink` | query | **publicProcedure** (no auth) |

Added `publicProcedure` to router imports.

### 5.5 [client/src/pages/ShareView.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/ShareView.tsx) (new)

Public read-only investor brief page. No login required. Shows:
- MIYAR branded header with expiry countdown + lock icon
- KPI strip (total fitout, cost/sqm, design premium)
- Design Identity + Design Direction key-values
- Budget bars by space + Market Benchmark overlay
- ROI Bridge (grade + net uplift)
- Market Intelligence / trends

Error state for invalid or expired tokens.

### 5.6 [client/src/pages/InvestorSummary.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/InvestorSummary.tsx) — Export + Share toolbar

- **Export DOCX** button — navigates to `/projects/:id/brief` (existing DOCX export)
- **Export PDF** button — fires `exportInvestorPdf` mutation → opens HTML blob in new tab → user prints as PDF
- **Share Link** button — fires `createShareLink` mutation → copies `/share/:token` URL to clipboard, shows "Copied!" toast for 3s

### Commit
`296f743` — 7 files, 838 insertions

## Phase 3 — Brief → Numbers

### 3.1 [server/engines/design-brief.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design-brief.ts)
- Added [PricingAnalytics](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design-brief.ts#10-37) interface (costPerSqmAvg, totalFitoutCostAed, totalCarbonKg, avgMaintenanceFactor, sustainabilityGrade, materialBreakdown, designPremiumAed, designPremiumPct)
- Added `TIER_MATERIAL_TYPES` map (which material types apply to Mid/Up-mid/Luxury/Ultra‑luxury)
- Added optional `materialConstants` parameter to [generateDesignBrief()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design-brief.ts#207-497)
- Computes `pricingAnalytics` block from material_constants and injects into the return value
- Engine now returns 7 fields (was 6): added `pricingAnalytics?`

### 3.2 [server/routers/design.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts)
- Fetches `matConstants` from DB in `generateBrief` endpoint (after livePricing)
- Passes to [generateDesignBrief()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design-brief.ts#207-497) so `pricingAnalytics` is populated in every new brief

### 3.3 [client/src/pages/BriefEditor.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/BriefEditor.tsx) (new)
- Route: `/projects/:id/brief-editor`
- 9 material type toggles (stone, glass, steel, aluminum, concrete, ceramic, wood, paint, insulation)
- Area allocation slider per material (1–40% of project GFA)
- Live cost via `design.calculateSpec` mutation — fires on every user interaction
- Displays: Total Fitout Cost, Sustainability Grade (A–E), Maintenance Factor, Carbon kg CO₂
- Per-material breakdown table with AED/m² badges
- ROI Bridge mini-panel with deep link to InvestorSummary
- UAE Market Constants sidebar reference table

### Navigation
- **Brief Editor** button (emerald, Calculator icon) added to [ProjectDetail.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/ProjectDetail.tsx) header
- [App.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/App.tsx) route `/projects/:id/brief-editor` registered

### Commit
`ca40d00` — 5 files, 529 insertions
