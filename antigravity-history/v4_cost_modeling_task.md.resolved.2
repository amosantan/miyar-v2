## Phase 1: Planning and Research
- [x] Analyze `evidence_records` and `benchmark_proposals` to understand live market data flow.
- [x] Analyze [server/engines/design-brief.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design-brief.ts) BOQ cost generation logic.
- [x] Analyze [server/engines/design/rfq-generator.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design/rfq-generator.ts) material pricing logic.
- [x] Create [v4_cost_modeling_implementation_plan.md](file:///Users/amrosaleh/.gemini/antigravity/brain/7c19b7ce-bcbf-4927-9935-14273b999ad2/v4_cost_modeling_implementation_plan.md) outlining dynamic pricing engine.

## Phase 2: Building the Dynamic Pricing Engine
- [x] Create [server/engines/pricing-engine.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pricing-engine.ts).
- [x] Implement [getLiveCategoryPricing(finishLevel: string)](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pricing-engine.ts#59-97) to query approved `benchmark_proposals`.
- [x] Implement [syncMaterialsWithBenchmarks()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pricing-engine.ts#98-151) to bulk-update `materials.priceAedMin` and `priceAedMax` from approved benchmarks.

## Phase 3: Wiring Market Data to Output Briefs
- [x] Refactor [server/engines/design-brief.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/design-brief.ts) to calculate `boq.coreAllocations` bottom-up using dynamic prices from [getLiveCategoryPricing](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pricing-engine.ts#59-97).
- [x] Ensure `budget.costPerSqmTarget` is derived from real dynamic prices rather than static mappings.

## Phase 4: Admin Endpoints and Testing
- [x] Add `syncMaterialPricing` TRPC endpoint in [server/routers/admin.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/admin.ts).
- [x] Add `previewLive` TRPC query in [server/routers/admin.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/admin.ts).
- [x] Wire [getLiveCategoryPricing](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pricing-engine.ts#59-97) into [server/routers/design.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design.ts) createDesignBrief mutation.
- [ ] Validate v28 tests pass with the new optional `livePricing` parameter.
- [ ] Commit and push changes.
