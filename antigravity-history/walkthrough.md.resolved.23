# Phase C Walkthrough: Portfolio Feature

## Summary
Implemented the Portfolio management feature for MIYAR — from database schema through full-stack CRUD to a user-facing page accessible at `/portfolio`.

## Changes Made

### C1: Schema Tables
- Added `portfolios` table (id, name, description, organization_id, created_by, timestamps)
- Added `portfolio_projects` junction table (portfolio_id, project_id, note, added_at)
- Migration applied via `drizzle-kit push`

### C2+C3: Portfolio Engine & CRUD Router
- Created [portfolio.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/portfolio.ts) with 8 endpoints:
  - [list](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#1559-1569) — all org portfolios with project count + avg score/risk
  - `getById` — full detail with analytics (distributions, heatmap, failure patterns, improvement levers)
  - [create](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#161-167) / [update](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#193-198) / [delete](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#199-204) — standard CRUD
  - `addProject` / `removeProject` — manage portfolio membership
  - `availableProjects` — projects not yet in a portfolio
- Registered in [routers.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers.ts) as `portfolio`

### C4: Portfolio Page
- Created [PortfolioPage.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/PortfolioPage.tsx):
  - **List View**: Portfolio cards with project count, avg score, delete. Create dialog.
  - **Detail View**: Project table with scores, add/remove projects, failure patterns, improvement levers, score distributions.
- Added route `/portfolio` in [App.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/App.tsx)
- Added sidebar nav link in [DashboardLayout.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/components/DashboardLayout.tsx) under Analysis section

## Verification
- TypeScript compilation: ✅ No new errors (all existing errors are pre-existing in unrelated files)
- Schema migration: ✅ `drizzle-kit push` applied cleanly
- All lint errors in portfolio router fixed

## C5: Portfolio PDF Report
- Added [PortfolioPDFInput](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pdf-report.ts#1049-1086) interface and [generatePortfolioReportHTML()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pdf-report.ts#1087-1253) to [pdf-report.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pdf-report.ts)
  - Sections: Cover page, executive summary (4 metrics), project comparison table, score distributions, compliance heatmap, failure patterns, improvement levers
- Added [generateReport](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pdf-report.ts#1032-1046) mutation to [portfolio.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/portfolio.ts) router
  - Builds `PortfolioProject[]` with nested `{project, scoreMatrix, intelligence}` structure
  - Converts `ComplianceCell[]` → tier-grouped heatmap format for PDF
- Added "Export Report" button to [PortfolioPage.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/PortfolioPage.tsx) detail view
  - Downloads HTML report file on click

## Verification
- TypeScript compilation: ✅ No new errors
- Schema migration: ✅ Applied cleanly
- All lint errors in portfolio router fixed

## C6: Portfolio Alerts
- Added `portfolio_risk` and `portfolio_failure_pattern` to alert enum in schema
- Created `checkAlerts` endpoint in portfolio router — 4 alert rules
- Added "Check Alerts" button to PortfolioPage

---

## Phase D: Risk & Economic Modeling ✅

### D1-D4 Backend — [scenario.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/scenario.ts)

| Endpoint | Engine | Persists To |
|---|---|---|
| `stressTest` / `listStressTests` | [stress-tester.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/risk/stress-tester.ts) | `scenario_stress_tests` |
| `calculateRoi` | [roi-calculator.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/economic/roi-calculator.ts) (cost-avoidance + programme-acceleration) | `project_roi_models` |
| `generateRiskSurface` / `getRiskSurface` | [risk-evaluator.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/risk/risk-evaluator.ts) (8 domains, R=P×I×V/C) | `risk_surface_maps` |
| [rank](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/autonomous/scenario-ranking.ts#14-42) | [scenario-ranking.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/autonomous/scenario-ranking.ts) (50% ROI + 30% Resilience + 20% Inverse Risk) | Aggregated |

### D5: Stress Test Panel — [Scenarios.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/Scenarios.tsx)
- 4 conditions × N scenarios grid with Run buttons
- Shows resilience scores (color-coded) and failure points

### D6: Risk Heatmap Page — [RiskHeatmap.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/RiskHeatmap.tsx)
- New page at `/risk-heatmap` with nav link
- Overall risk summary with band badges
- Heat-colored 8×4 factor matrix (domains × P/I/V/C)
- Per-domain summary cards

### D7: Economic Panel — [Scenarios.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/Scenarios.tsx)
- ROI breakdown per scenario (rework avoided, acceleration, total value, net ROI %)
- Strategic ranking table with weighted scores

### Verification
- `npx tsc --noEmit` — 0 new errors from Phase D files
