# Phase C Walkthrough: Portfolio Feature

## Summary
Implemented the Portfolio management feature for MIYAR — from database schema through full-stack CRUD to a user-facing page accessible at `/portfolio`.

## Changes Made

### C1: Schema Tables
- Added `portfolios` table (id, name, description, organization_id, created_by, timestamps)
- Added `portfolio_projects` junction table (portfolio_id, project_id, note, added_at)
- Migration applied via `drizzle-kit push`

### C2+C3: Portfolio Engine & CRUD Router
- Created [portfolio.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/portfolio.ts) with 8 endpoints:
  - [list](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#1559-1569) — all org portfolios with project count + avg score/risk
  - `getById` — full detail with analytics (distributions, heatmap, failure patterns, improvement levers)
  - [create](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#887-893) / [update](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#193-198) / [delete](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#199-204) — standard CRUD
  - `addProject` / `removeProject` — manage portfolio membership
  - `availableProjects` — projects not yet in a portfolio
- Registered in [routers.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers.ts) as `portfolio`

### C4: Portfolio Page
- Created [PortfolioPage.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/PortfolioPage.tsx):
  - **List View**: Portfolio cards with project count, avg score, delete. Create dialog.
  - **Detail View**: Project table with scores, add/remove projects, failure patterns, improvement levers, score distributions.
- Added route `/portfolio` in [App.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/App.tsx)
- Added sidebar nav link in [DashboardLayout.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/components/DashboardLayout.tsx) under Analysis section

## Verification
- TypeScript compilation: ✅ No new errors (all existing errors are pre-existing in unrelated files)
- Schema migration: ✅ `drizzle-kit push` applied cleanly
- All lint errors in portfolio router fixed

## C5: Portfolio PDF Report
- Added `PortfolioPDFInput` interface and `generatePortfolioReportHTML()` to [pdf-report.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/pdf-report.ts)
  - Sections: Cover page, executive summary (4 metrics), project comparison table, score distributions, compliance heatmap, failure patterns, improvement levers
- Added `generateReport` mutation to [portfolio.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/portfolio.ts) router
  - Builds `PortfolioProject[]` with nested `{project, scoreMatrix, intelligence}` structure
  - Converts `ComplianceCell[]` → tier-grouped heatmap format for PDF
- Added "Export Report" button to [PortfolioPage.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/PortfolioPage.tsx) detail view
  - Downloads HTML report file on click

## Verification
- TypeScript compilation: ✅ No new errors
- Schema migration: ✅ Applied cleanly
- All lint errors in portfolio router fixed

## C6: Portfolio Alerts
- Added `portfolio_risk` and `portfolio_failure_pattern` to alert enum in schema
- Created `checkAlerts` endpoint in portfolio router — 4 alert rules
- Added "Check Alerts" button to PortfolioPage

---

## Phase D: Risk & Economic Modeling ✅

### D1-D4 Backend — [scenario.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/scenario.ts)

| Endpoint | Engine | Persists To |
|---|---|---|
| `stressTest` / `listStressTests` | [stress-tester.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/risk/stress-tester.ts) | `scenario_stress_tests` |
| `calculateRoi` | [roi-calculator.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/economic/roi-calculator.ts) (cost-avoidance + programme-acceleration) | `project_roi_models` |
| `generateRiskSurface` / `getRiskSurface` | [risk-evaluator.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/risk/risk-evaluator.ts) (8 domains, R=P×I×V/C) | `risk_surface_maps` |
| [rank](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/autonomous/scenario-ranking.ts#14-42) | [scenario-ranking.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/autonomous/scenario-ranking.ts) (50% ROI + 30% Resilience + 20% Inverse Risk) | Aggregated |

### D5: Stress Test Panel — [Scenarios.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/Scenarios.tsx)
- 4 conditions × N scenarios grid with Run buttons
- Shows resilience scores (color-coded) and failure points

### D6: Risk Heatmap Page — [RiskHeatmap.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/RiskHeatmap.tsx)
- New page at `/risk-heatmap` with nav link
- Overall risk summary with band badges
- Heat-colored 8×4 factor matrix (domains × P/I/V/C)
- Per-domain summary cards

### D7: Economic Panel — [Scenarios.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/Scenarios.tsx)
- ROI breakdown per scenario (rework avoided, acceleration, total value, net ROI %)
- Strategic ranking table with weighted scores

### Verification
- `npx tsc --noEmit` — 0 new errors from Phase D files

---

## Phase E: Cognitive Bias Detection ✅

### Foundation (already existed)
- [bias-detector.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/bias/bias-detector.ts) (584 lines, 7 detectors), [bias-types.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/bias/bias-types.ts) (108 lines)
- `biasAlerts` + `biasProfiles` schema tables
- [BiasAlerts.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/components/BiasAlerts.tsx) component embedded in ProjectDetail
- [detectBiases()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/bias/bias-detector.ts#545-581) called during project evaluation in [project.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/project.ts)
- DB functions: [getUserBiasProfile](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#1929-1935), [upsertBiasProfile](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#1936-1977), [getBiasAlertsByProject](file:///Users/amrosaleh/Maiyar/miyar-v2/server/db.ts#1902-1909), etc.

### E2: On-demand scan + dashboard query — [bias.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/bias.ts)
- `scan` mutation: loads project → latest score matrix → builds DetectorContext → runs [detectBiases()](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/bias/bias-detector.ts#545-581) → persists alerts + updates profiles
- `getAllActiveAlerts` query: aggregates active alerts across all user projects

### E3: Bias Insights page — [BiasInsights.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/BiasInsights.tsx)
- Radar chart showing 7-bias fingerprint from historical profile
- Profile summary cards with occurrence counts, avg severity, trend indicators
- On-demand scan: project selector + "Scan for Biases" button
- Cross-project active alerts with expand/dismiss/evidence details

### Verification
- `npx tsc --noEmit` — 0 new errors from Phase E files

---

## Phase F: Monte Carlo & Time-Series ✅

### F1: Monte Carlo Engine — [monte-carlo.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/predictive/monte-carlo.ts)
- Box-Muller normal sampling for base cost, uniform for GFA and trend
- 10,000 iterations (configurable 100-50K)
- Outputs: P5-P95 percentiles, 20-bucket histogram, monthly time-series (P10/P50/P90), VaR at 95%, budget exceed probability

### F2: Schema — `monteCarloSimulations` table in [schema.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts)

### F3: Router — [scenario.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/scenario.ts)
- [runMonteCarlo](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/predictive/monte-carlo.ts#111-242) mutation, `getSimulations` query, `getSimulation` query

### F4: Simulations Page — [Simulations.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/Simulations.tsx)
- Key metrics: P50, 90% CI range, VaR@95%, budget exceed probability
- Distribution histogram with P50 highlight
- Time-series area chart with P10/P50/P90 confidence bands
- Full 7-percentile breakdown table

### Verification
- `npx tsc --noEmit` — 0 new errors from Phase F files

---

## Phase G: Customer Success ✅

### G1: Health Score Engine — [health-score.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/customer/health-score.ts)
- 4 weighted dimensions: Engagement (30%), Adoption (25%), Quality (25%), Velocity (20%)
- Tier classification: Thriving (85+), Healthy (65+), At Risk (40+), Churning (<40)
- Personalized recommendations based on weak dimensions

### G2: Schema — `customerHealthScores` table in [schema.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts)

### G3: Router — [customer-success.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/customer-success.ts)
- [calculateHealth](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/customer/health-score.ts#225-249) mutation, `getHealth` query, `getActivityFeed` query
- Registered in [routers.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers.ts)

### G4: Dashboard Page — [CustomerSuccess.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/CustomerSuccess.tsx)
- SVG health gauge (0-100, color-coded by tier)
- 4 dimension cards with progress bars and factor breakdowns
- Recommendations panel
- Activity feed from audit logs

### Verification
- `npx tsc --noEmit` — 0 new errors from Phase G files

---

## Phase H: Digital Twin & Sustainability ✅

### H1: Digital Twin Engine — [digital-twin.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/sustainability/digital-twin.ts)
- ICE v3 material database (9 materials: concrete, steel, glass, aluminum, timber, stone, gypsum, insulation, ceramic)
- UAE climate-adapted energy calculator with cooling/lighting/equipment breakdown
- 30-year lifecycle costing with 3% annual escalation
- 4-factor sustainability scoring: carbon efficiency (35%), energy rating (30%), material circularity (20%), water efficiency (15%)
- Contextual recommendations for improvement

### H2: Schema — `digitalTwinModels` table in [schema.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/drizzle/schema.ts)

### H3: Router — [sustainability.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/sustainability.ts)
- `computeTwin` mutation, `getTwinModels` query, `getLatestTwin` query
- Registered in [routers.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers.ts)

### H4: Dashboard Page — [Sustainability.tsx](file:///Users/amrosaleh/Maiyar/miyar-v2/client/src/pages/Sustainability.tsx)
- SVG score ring with grade (A+ to F)
- 5 key metric cards (carbon, energy, lifecycle, cooling)
- 4 sub-score progress bars
- Horizontal bar chart for carbon breakdown by material
- Area chart for 30-year lifecycle cost projection
- Recommendations panel

### Verification
- `npx tsc --noEmit` — 0 new errors from Phase H files
