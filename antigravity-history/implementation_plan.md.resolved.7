# Strategic Data Utilization Plan: Source-Type Intelligence

The recent ingestion upgrade added high-fidelity, source-specific data to our `evidence_records` (specifically `finishLevel`, `designStyle`, `brandsMentioned`, `materialSpec`, and `intelligenceType`). 

To maximize the value of this data across the MIYAR platform, we need to transition our analytics and benchmarking from a **general category-based model** to a **segmented, context-aware model**.

## User Review Required

> [!IMPORTANT]
> This plan proposes changes to how benchmark proposals are grouped and how market trends are calculated. Please review the proposed new grouping keys and insight triggers. 

## Proposed Changes

### MIYAR Analytics Engine

Enhance the analytics and intelligence generation to leverage qualitative data.

#### [MODIFY] [server/engines/analytics/trend-detection.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/analytics/trend-detection.ts)
- Segment moving averages by `finishLevel` and `designStyle` (e.g., detecting if "Luxury" materials are facing higher cost pressure than "Standard" materials).
- Track brand momentum based on frequency of `brandsMentioned` in recent scrapes.

#### [MODIFY] [server/engines/analytics/insight-generator.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/analytics/insight-generator.ts)
- Add new deterministic triggers:
  - `style_shift`: Triggered when a specific `designStyle` (e.g., "Minimalist", "Neo-Classic") shows a >20% increase in `developer_brochure` mentions.
  - `brand_dominance`: Triggered when a specific brand dominates the `brandsMentioned` array in a category (e.g., "Grohe accounts for 60% of sanitaryware in Premium projects").
  - `spec_inflation`: Triggered when average `priceTypical` for a specific `finishLevel` increases while the generic category average remains flat.

### Benchmark Proposals Generator

Proposals are currently generated by grouping evidence by `category:unit`. This blends ultra-luxury specs with budget materials, diluting accuracy. 

#### [MODIFY] [server/engines/ingestion/proposal-generator.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/ingestion/proposal-generator.ts)
- Update the grouping key from `${rec.category}:${rec.unit}` to `${rec.category}:${rec.finishLevel || 'standard'}:${rec.unit}`.
- This ensures that when a user requests a benchmark for "Luxury Flooring", they get the P25/P50/P75 of *only* luxury flooring evidence.
- Introduce `designStyle` as a secondary benchmark filter for highly specific recommendations.

### Design Advisor & Market Intelligence

Leverage Developer and Market Research intelligence for generative insights.

#### [MODIFY] [server/routers/design-advisor.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/design-advisor.ts)
- When suggesting materials for a user's project, query `evidence_records` filtering by the project's target `designStyle` (e.g., "Modern") and `finishLevel`.
- Provide brand recommendations based on `brandsMentioned` in developer brochures matching the user's project criteria.

#### [MODIFY] [server/routers/market-intelligence.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/routers/market-intelligence.ts)
- Incorporate `intelligenceType` = `market_research` and `government_tender` directly into the top-level market reports.
- Extract high-level macro stats (permit counts, global trends) to formulate the "Market Overview" section of the reports.

## Verification Plan

### Automated Tests
- Run [v3-analytics.test.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/v3-analytics.test.ts) to ensure trend-detection logic handles the new segmented dimensions correctly.
- Add unit tests for [proposal-generator.ts](file:///Users/amrosaleh/Maiyar/miyar-v2/server/engines/ingestion/proposal-generator.ts) to verify that luxury and standard materials are not blended into the same benchmark bucket.

### Manual Verification
- Kick off a test benchmark proposal generation run (`npx tsx server/engines/ingestion/seeds/test-proposals.ts`) and verify that proposals are grouped by finish level (`floors:luxury:sqm` vs `floors:standard:sqm`).
- Check the Analytics Dashboard UI to ensure the new insights (`style_shift`, `brand_dominance`) render correctly.
